<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø³Ø§Ø¹Ø¯ Ù…ØªØ¬Ø± Ù†ÙˆØ±Ø§</title>
  <style>
    :root{
      --brand:#2ecc71;
      --bg:#f5f7fa;
      --card:#ffffff;
      --muted:#94a3b8;
      --bot:#eef2f7;
      --text:#0f172a;
      --shadow:0 14px 35px rgba(2, 6, 23, .10);
      --radius:18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 50% -200px, rgba(46,204,113,.25), transparent 60%),
                  var(--bg);
      font-family: Arial, sans-serif;
      color:var(--text);
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
      padding:16px;
    }

    .chat{
      width: 860px;
      max-width: 98vw;
      height: 92vh;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      border: 1px solid rgba(15, 23, 42, .06);
    }

    /* Header */
    .header{
      padding:14px 16px;
      background: linear-gradient(135deg, var(--brand), #25c765);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:bold;
      letter-spacing:.2px;
    }
    .brand .logo{
      width:34px;
      height:34px;
      border-radius:12px;
      background: rgba(255,255,255,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
    }
    .status{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      opacity:.95;
      white-space:nowrap;
    }
    .dot{
      width:9px;
      height:9px;
      border-radius:50%;
      background:#22c55e;
      box-shadow:0 0 0 3px rgba(34,197,94,.18);
    }
    .dot.off{ background:#ef4444; box-shadow:0 0 0 3px rgba(239,68,68,.18); }

    /* Messages */
    .messages{
      flex:1;
      padding:16px 14px;
      overflow:auto;
      background: linear-gradient(180deg, #f7fafc, #f6f9fb);
    }
    .day-sep{
      text-align:center;
      margin:10px 0 14px;
      font-size:12px;
      color: var(--muted);
    }

    .row{
      display:flex;
      margin:10px 0;
      gap:10px;
      align-items:flex-end;
    }
    .row.user{ justify-content:flex-end; }
    .row.bot{ justify-content:flex-start; }

    .avatar{
      width:34px;
      height:34px;
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 34px;
      user-select:none;
    }
    .row.bot .avatar{
      background:#e8f7ef;
      color:#0f5132;
      border:1px solid rgba(46,204,113,.25);
    }
    .row.user .avatar{
      background:#eaf0ff;
      color:#1d4ed8;
      border:1px solid rgba(29,78,216,.18);
      order: 2; /* ÙÙŠ RTL */
    }

    .bubble{
      max-width:min(74%, 620px);
      padding:11px 12px;
      border-radius:16px;
      line-height:1.6;
      font-size:14px;
      box-shadow: 0 6px 18px rgba(2,6,23,.06);
      position:relative;
      word-wrap:break-word;
      white-space:pre-wrap;
    }
    .row.user .bubble{
      background: var(--brand);
      color:#fff;
      border-bottom-right-radius:6px;
    }
    .row.bot .bubble{
      background: var(--bot);
      color: var(--text);
      border-bottom-left-radius:6px;
      border:1px solid rgba(15,23,42,.06);
      box-shadow:none;
    }

    .meta{
      margin-top:6px;
      font-size:11px;
      color: var(--muted);
    }
    .row.user .meta{ text-align:left; direction:ltr; } /* ÙˆÙ‚Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
    .row.bot .meta{ text-align:right; direction:ltr; }

    /* Typing indicator */
    .typing{
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .typing span{
      width:6px;height:6px;border-radius:50%;
      background:#94a3b8;
      animation: bounce 1.1s infinite;
      opacity:.85;
    }
    .typing span:nth-child(2){ animation-delay:.15s; }
    .typing span:nth-child(3){ animation-delay:.3s; }
    @keyframes bounce{
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-5px); }
    }

    /* Composer */
    .composer{
      padding:12px;
      border-top:1px solid rgba(15,23,42,.06);
      background:#fff;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .inputWrap{
      flex:1;
      background:#f8fafc;
      border:1px solid rgba(15,23,42,.08);
      border-radius:14px;
      padding:8px 10px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      font-size:14px;
      padding:8px 6px;
    }

    .btn{
      border:none;
      outline:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:14px;
      font-weight:bold;
      font-size:13px;
      transition: .15s ease;
    }
    .btn.send{
      background: var(--brand);
      color:#fff;
    }
    .btn.send:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
    .btn.ghost{
      background:#f1f5f9;
      color:#334155;
      border:1px solid rgba(15,23,42,.08);
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }

    /* Small screens */
    @media (max-width: 520px){
      .chat{ height: 94vh; }
      .bubble{ max-width: 86%; }
      .btn.ghost{ display:none; }
      .status{ display:none; }
    }
  </style>
</head>
<body>

<div class="chat">
  <div class="header">
    <div class="brand">
      <div class="logo">ğŸ¤–</div>
      <div>
        Ù…Ø³Ø§Ø¹Ø¯ Ù…ØªØ¬Ø± Ù†ÙˆØ±Ø§
        <div style="font-size:12px; opacity:.9; font-weight:normal;">Ø§Ù‡Ù„Ù† ÙˆØ³Ù‡Ù„Ø§  Ø¨Ùƒ Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ </div>
      </div>
    </div>

    <div class="status" id="status">
      <span class="dot" id="dot"></span>
      <span id="statusText">Ù…ØªØµÙ„</span>
    </div>
  </div>

  <div id="messages" class="messages">
    <div class="day-sep" id="daySep"></div>
  </div>

  <div class="composer">
    <button class="btn ghost" id="clearBtn" title="Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©">Ù…Ø³Ø­</button>
    <div class="inputWrap">
      <input id="text" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." autocomplete="off" />
    </div>
    <button class="btn send" id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<script>
  const API_URL = "https://noura-chat-api.onrender.com/chat";

  const messages = document.getElementById("messages");
  const text = document.getElementById("text");
  const sendBtn = document.getElementById("sendBtn");
  const clearBtn = document.getElementById("clearBtn");

  const dot = document.getElementById("dot");
  const statusText = document.getElementById("statusText");
  const daySep = document.getElementById("daySep");

  function nowTime(){
    const d = new Date();
    const h = String(d.getHours()).padStart(2,'0');
    const m = String(d.getMinutes()).padStart(2,'0');
    return `${h}:${m}`;
  }

  function setDaySeparator(){
    const d = new Date();
    const days = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];
    daySep.textContent = `${days[d.getDay()]} â€¢ ${d.toLocaleDateString("ar")}`;
  }

  function setStatus(ok){
    if(ok){
      dot.classList.remove("off");
      statusText.textContent = "Ù…ØªØµÙ„";
    }else{
      dot.classList.add("off");
      statusText.textContent = "ØºÙŠØ± Ù…ØªØµÙ„";
    }
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function addMsg(content, who="bot", meta="", isTyping=false) {
    const row = document.createElement("div");
    row.className = "row " + (who === "user" ? "user" : "bot");

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.textContent = (who === "user") ? "ğŸ§‘" : "ğŸ¤–";

    const bubble = document.createElement("div");
    bubble.className = "bubble";

    if(isTyping){
      bubble.innerHTML = `<span class="typing"><span></span><span></span><span></span></span>`;
    }else{
      bubble.innerHTML = escapeHtml(content);
    }

    const wrap = document.createElement("div");
    wrap.appendChild(bubble);

    if(meta){
      const m = document.createElement("div");
      m.className = "meta";
      m.textContent = meta;
      wrap.appendChild(m);
    }

    // ØªØ±ØªÙŠØ¨ RTL: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…ÙŠÙ†ØŒ Ø§Ù„Ø¨ÙˆØª ÙŠØ³Ø§Ø±
    if(who === "user"){
      row.appendChild(wrap);
      row.appendChild(avatar);
    }else{
      row.appendChild(avatar);
      row.appendChild(wrap);
    }

    messages.appendChild(row);
    messages.scrollTo({ top: messages.scrollHeight, behavior: "smooth" });
    return row;
  }

  let typingRow = null;

  function showTyping(){
    if(typingRow) return;
    typingRow = addMsg("", "bot", "", true);
  }

  function hideTyping(){
    if(!typingRow) return;
    typingRow.remove();
    typingRow = null;
  }

  async function healthCheck(){
    try{
      // Render Ù‚Ø¯ ÙŠÙ†Ø§Ù… Ø£Ø­ÙŠØ§Ù†Ù‹Ø§ØŒ Ù†ØªØ­Ù‚Ù‚ Ø¨Ø³Ø±Ø¹Ø©
      const res = await fetch(API_URL, { method:"OPTIONS" });
      setStatus(res.ok || res.status === 204);
    }catch(e){
      setStatus(false);
    }
  }

  async function send() {
    const msg = text.value.trim();
    if (!msg) return;

    text.value = "";
    addMsg(msg, "user", nowTime());

    sendBtn.disabled = true;
    showTyping();

    try {
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({message: msg})
      });

      if(!res.ok){
        throw new Error("HTTP " + res.status);
      }

      const data = await res.json();
      hideTyping();

      // Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ¯Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø¨Ø¯ÙˆÙ† Ø¥Ø²Ø¹Ø§Ø¬
      const src = data.source ? ` â€¢ ${data.source}` : "";
      addMsg(data.answer ?? "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.", "bot", nowTime() + src);

      setStatus(true);
    } catch (e) {
      hideTyping();
      setStatus(false);
      addMsg("Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„.", "bot", nowTime());
    } finally {
      sendBtn.disabled = false;
      text.focus();
    }
  }

  // Ø£Ø­Ø¯Ø§Ø«
  sendBtn.addEventListener("click", send);
  text.addEventListener("keydown", (e) => {
    if (e.key === "Enter") send();
  });

  clearBtn.addEventListener("click", () => {
    messages.innerHTML = `<div class="day-sep" id="daySep"></div>`;
    // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· daySep Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø³Ø­
    document.getElementById("daySep").textContent = daySep.textContent;
    // Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
    addMsg("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…ØªØ¬Ø± Ù†ÙˆØ±Ø§. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø§Ù„Ø´Ø­Ù†ØŒ Ø§Ù„Ø¯ÙØ¹ØŒ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ØŒ Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø£Ùˆ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰.", "bot", nowTime());
  });

  // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
  setDaySeparator();
  addMsg("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…ØªØ¬Ø± Ù†ÙˆØ±Ø§. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø§Ù„Ø´Ø­Ù†ØŒ Ø§Ù„Ø¯ÙØ¹ØŒ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ØŒ Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø£Ùˆ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰.", "bot", nowTime());
  healthCheck();
</script>

</body>
</html>

